#!/usr/bin/env bash

# ===== OS判別とプレイヤー設定 =====
if [[ "$OSTYPE" == "darwin"* ]]; then
  # macOSの場合
  PLAYER="afplay"
else
  # Linux（またはその他）の場合
  PLAYER="mpg123 -q"
fi

VOICES=(./v{1..9}.mp3)

# ===== AA =====
AA=$(cat <<'EOF'
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⠄⠄⡀⠄⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⠠⢐⣠⡤⠶⢛⣛⡭⢭⡭⠭⠭⢍⣙⣛⣛⠶⠤⣄⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⢀⠄⣨⠶⡫⢕⢝⣗⣕⡺⣎⣭⠷⠛⠉⢡⡖⣒⡄⡀⠈⠉⠓⢮⡛⣦⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⣀⡾⢭⡮⡪⢸⡳⢸⣧⠞⠉⡀⢀⣀⡤⠴⠶⠒⠚⠛⠛⠛⠓⠲⠦⣬⣷⠹⡌⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⢀⢞⣴⣿⣝⢕⢅⣋⡿⠁⡀⣤⠞⠉⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⠉⠿⣄⣀⣬⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⣴⣱⡗⢝⢮⠝⡧⣾⠁⣀⠶⠉⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⣄⡀⡀⡀⡀⠈⢦⡀⡀⢀⡞⠄⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⣾⡜⣽⣕⣼⣽⣼⠡⣃⠟⡠⡀⡀⡀⡀⡀⡀⣄⡀⡀⠁⡀⡀⡀⡀⡀⢷⡀⡀⠄⡀⡀⠙⡄⡀⢧⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⠠⣼⣽⣷⢽⡯⢿⣾⣸⢸⢲⠠⡀⣸⡀⡀⡀⡀⡀⣽⣰⡀⡀⡀⡀⣼⡀⡀⢸⠾⣄⡀⡀⢠⡀⠘⡀⡀⢧⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⢠⢧⣿⣿⣿⣬⡎⠇⢇⡿⢠⡀⡀⡇⡀⡀⢀⡀⢐⠋⡀⡀⡀⡀⣰⡇⡀⡀⣸⡀⠈⠖⠶⡦⠶⠦⡇⡀⡀⣇⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⣾⣿⣿⣿⣿⣇⡾⣼⣴⣡⠟⡀⡀⡇⢸⡀⠁⢀⠏⡀⠧⡤⠶⠶⠃⠙⠉⠁⡀⡀⣉⡛⠿⡌⡄⡀⡀⡀⡀⠘⡌⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⠂⡯⣿⣿⣿⠿⣳⢡⡫⡇⣇⢸⡀⡀⠈⠉⣿⠉⣠⠟⠉⡀⣀⡀⡀⡀⡀⡀⢀⣶⢿⡀⡀⢳⡀⠸⣀⡀⡀⡀⡀⢻⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⢠⣳⣿⣿⣿⣶⢃⢯⡾⡀⡇⢸⡀⡀⡀⡀⢽⠈⠋⣾⣿⣇⡀⠹⣄⡀⡀⡀⢺⡷⣿⣖⣿⣻⠓⠦⡀⡀⠉⠲⡀⠈⡄⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⢸⣺⣿⠿⣯⠏⡟⡾⡐⠉⡀⢸⡀⡀⡀⠨⢹⡀⡀⣿⣷⣦⣿⣟⣟⡇⡀⡀⡀⠓⠶⠷⠿⠿⣄⣀⠇⡄⠉⡀⢹⡀⣇⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⣾⣵⢿⣶⢋⢿⡿⡀⡇⡀⡀⣿⡀⡀⡀⡀⣹⡀⡞⠘⣄⣀⣿⠛⠛⢀⡴⢟⡶⠄⡀⡀⠆⡀⡀⠲⡀⠈⡀⡀⣸⡀⢹⠁⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⣿⣃⡿⣡⣫⢟⣤⠞⡀⡀⡼⡏⡀⡀⡀⡀⣿⡀⠳⡤⠟⡀⡀⡀⢰⠁⡀⡀⡇⡀⡀⡀⠈⡀⡀⡀⡀⡀⡀⣠⠃⡀⢸⠰⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⠂⠿⣩⢞⡾⠁⡿⡀⡀⡀⡀⠇⡇⡀⡀⡀⡀⡏⡆⠈⡀⡀⡀⡀⡀⡏⡀⡀⣸⡀⡀⡀⡀⡀⡀⠁⠒⠂⣀⠾⠁⡀⡀⣸⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⢈⡿⣽⠞⡡⢤⠞⠁⡀⡀⡀⣼⢠⡀⡀⡀⡀⡀⠇⡀⡀⢠⠃⡀⡀⡀⣇⣀⡴⠁⡀⡀⡀⡀⡀⣀⣤⠖⠉⣼⡀⡀⡀⡀⡟⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⢂⠟⠋⡀⣰⡀⡀⣀⣠⣤⠶⠶⢿⣹⡀⡀⣸⡀⢰⢛⢶⠶⣤⠤⢤⣤⣤⣤⢤⠤⣤⡴⢶⠛⠉⠁⡀⡀⡀⡀⡇⠂⡀⡀⢠⢁⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⠘⣖⢉⠉⡀⣠⢟⡾⣡⡄⡀⡀⡀⡏⡀⡀⡏⡀⡿⡯⣺⢹⡬⢷⣄⠙⠛⠉⡀⢠⢿⣿⣿⢿⡀⡀⡀⡀⡀⢀⠁⡀⢰⡀⡟⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⢠⢗⣾⣼⣳⠁⢠⡶⣰⣀⣠⢾⣀⣼⡌⢧⣽⡺⠷⡋⡆⢙⠛⠚⡀⣿⣿⣿⡵⢼⡀⡀⡀⡀⡀⡾⢀⡴⣏⠞⠄⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⠄⣟⣗⡏⠁⡀⡀⣿⣿⡇⡀⣼⣹⢸⢽⣿⣮⢝⡳⣸⠇⡧⠚⠚⣄⢰⣽⣫⣪⡗⡞⡀⡀⡀⡀⡀⠈⡀⡀⡇⠁⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⣶⣽⢵⢓⡀⡀⡀⠙⠿⡀⣰⣝⡯⣦⢷⡯⣿⣿⣗⣽⢪⣨⢽⠿⣯⡾⡵⠿⡫⢹⡀⡀⡀⡀⡀⢸⡀⡀⡀⡇⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⠠⣿⣿⣞⣧⡞⢀⣶⢶⣾⣿⣀⣍⠻⠻⠿⣻⢰⢾⡯⡺⢻⠈⠉⠉⣿⣿⡇⣾⡮⢸⡀⡀⡀⡀⡀⢸⡀⡀⡀⡇⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡯⣿⣿⣷⣯⣽⠿⢿⡶⡿⠦⣄⣉⣈⣻⣻⡎⣺⣻⢞⣻⡀⡀⡀⢸⢽⢇⡽⡗⢸⡀⡀⡀⡀⡀⢸⡀⡀⡀⠃⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⢀⠿⣤⠾⢿⣨⣟⣳⡿⠋⣠⣛⠶⠖⠒⡇⣿⣗⣻⡗⣺⢹⡀⡀⡀⠘⣞⢜⣝⡮⢸⡀⡀⡀⡀⡀⣾⡀⡀⢰⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⣐⣈⣹⣄⣉⡉⠉⣬⣀⣠⠓⠒⡿⠛⠒⠚⠛⡈⣿⣯⣕⢝⢸⡀⡀⡀⡀⡯⡸⣯⣵⡃⡄⡀⡀⡀⣰⡾⡀⡀⢸⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⣰⢫⢁⡾⡀⡀⡀⡀⠈⠉⠓⠋⠚⠉⠉⡏⠈⠙⠁⠉⣹⣿⡹⡟⢝⢹⡀⡀⡀⡀⡿⠼⠭⠭⠖⡇⡀⡀⢀⢃⠃⡀⡀⠏⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⠂⡇⡟⡞⠇⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⢠⡀⡀⡀⡀⡀⡇⣇⠈⠉⠉⡀⡀⡀⡀⡀⠷⠤⣤⣤⢶⡁⡀⢀⠋⠟⡀⢀⠟⠂⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⢰⡀⡇⣗⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⣀⠏⡀⡀⣀⣤⠞⠛⢳⠉⠛⠛⠛⡖⠒⠒⠒⠒⢤⣤⣀⣀⡼⠖⢁⠿⠶⠛⠁⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⠩⠉⢙⠛⠛⠒⠒⠒⠒⠛⠛⠋⠉⠉⠩⡀⡀⠈⡀⡀⡀⠨⠉⠛⠍⠐⡀⡀⡀⡀⡀⠁⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀⡀
[1-9] 音声  /  r ランダム  /  g ゲーミングｽﾋﾟｷ  /  q 終了
EOF
)

clear
echo "$AA"

# ===== 虹色グラデーションAA（macOS最適化版）=====
rainbow_aa() {
  local frame=0
  local start_row=1
  local height
  height=$(echo "$AA" | wc -l)

  # 256色モード用のレインボーカラーパレットを事前に定義（計算負荷軽減）
  local colors=(196 202 208 214 220 226 190 154 118 82 46 47 48 49 51 45 39 33 27 21 57 93 129 165 201 197)
  local num_colors=${#colors[@]}

  while true; do
    # カーソルを上部に戻す
    printf "\e[%d;1H" $start_row

    local y=0
    while IFS= read -r line; do
      local out=""
      local len=${#line}
      
      for ((i=0; i<len; i++)); do
        char="${line:i:1}"
        if [[ "$char" == " " || "$char" == "　" ]]; then
          out+="$char"
        else
          # 色のインデックスを計算
          local color_idx=$(( (frame + i + y*2) % num_colors ))
          local color=${colors[$color_idx]}
          out+="\e[38;5;${color}m${char}"
        fi
      done
      
      # 1行まとめて出力（高速化）
      printf "%b\e[0m\n" "$out"
      ((y++))
    done <<< "$AA"

    ((frame++))
    sleep 0.03
  done
}

# ランダム
random_loop() {
  while true; do
    $PLAYER "${VOICES[$((RANDOM % 9))]}" >/dev/null 2>&1
    sleep 0.2
  done
}


# ===== 後始末 =====
cleanup() {
  [ -n "$RAINBOW_PID" ] && kill "$RAINBOW_PID" 2>/dev/null
  [ -n "$RANDOM_PID" ] && kill "$RANDOM_PID" 2>/dev/null
  tput cnorm
  exit
}
trap cleanup EXIT

tput civis

# ===== キー入力（Enter不要）=====
while true; do
  read -rsn1 key
  case "$key" in
    [1-9])
      $PLAYER "${VOICES[$((key-1))]}" >/dev/null 2>&1 &
      ;;
    r)
      if [ "$RANDOM_MODE" -eq 0 ]; then
        RANDOM_MODE=1
        random_loop &
        RANDOM_PID=$!
      else
        RANDOM_MODE=0
        kill "$RANDOM_PID" 2>/dev/null
      fi
      ;;
    g)
      if [ "$RAINBOW" -eq 0 ]; then
        RAINBOW=1
        rainbow_aa &
        RAINBOW_PID=$!
      else
        RAINBOW=0
        kill "$RAINBOW_PID" 2>/dev/null
        clear
        echo "$AA"
      fi
      ;;
    q)
      exit
      ;;
  esac
done
